---
name: question-solve-flow
description: |
  生产环境问题排查与解决的标准工作流程。当用户需要解决生产环境异常、系统故障、服务报错等问题时触发。
  触发场景：
  1. 用户提供 jaeger 链路追踪数据需要分析
  2. 用户报告生产环境异常需要排查
  3. 用户需要定位服务报错原因
  4. 问题涉及多服务调用链分析
---

# 生产环境问题处理流程

## 工作流程概览

```
接收问题 → 解析 Jaeger → 获取源码 → 查询数据库 → 综合分析 → 给出解决方案
```

## 详细步骤

### Step 1: 接收并理解问题

**操作要点：**

- 明确问题现象：什么服务、什么接口、什么异常
- 收集关键信息：时间范围、影响范围、错误表现
- 确认是否提供 jaeger 数据

**判断逻辑：**

- 如果用户提供了 jaeger 链接或数据 → 进入 Step 2
- 如果未提供但问题涉及服务调用链 → 询问用户获取 jaeger

---

### Step 2: 解析 Jaeger 链路追踪

**触发条件：** 存在 jaeger 数据

**执行操作：**

1. 调用 `jaeger-analysis` skill 解析 jaeger
2. 提取关键信息：
   - 异常发生的服务和时间点
   - 完整的错误堆栈信息
   - 调用链路上的各个服务节点
   - 涉及的数据库查询 SQL（如有）

**输出要求：**

- 记录异常服务名称
- 记录异常发生的代码位置（类名、方法名、行号）
- 记录完整的异常堆栈

---

### Step 3: 获取源码补充上下文

**触发条件：** 已从 jaeger 获取到堆栈信息

**执行操作：**

1. 从堆栈信息中识别：
   - 报错的服务名称
   - 报错的代码文件路径
   - 相关的业务逻辑位置
2. 调用 `git-fetch` skill 获取对应服务的源码
3. 读取关键代码文件，理解业务逻辑

**输出要求：**

- 找到报错的代码位置
- 理解代码的业务意图
- 标记可能的问题点

---

### Step 4: 查询数据库验证数据

**触发条件：** 问题涉及数据判断逻辑、数据状态或数据一致性

**执行操作：**

1. 从 jaeger 或源码中提取相关 SQL
2. 调用 `database_query` skill 执行查询
3. 关键数据检查项：
   - 数据是否存在
   - 数据状态是否正确
   - 关联数据是否完整
   - 时间戳是否合理

**约束条件：**

- ⚠️ **只允许 SELECT 查询，禁止 INSERT/UPDATE/DELETE**
- 查询前确认租户 ID 和环境（feature/test/pre/prod）
- 敏感数据需脱敏处理

---

### Step 5: 综合分析定位根因

**分析维度：**

1. **代码层面：** 是否有空指针、数组越界、类型转换等异常
2. **数据层面：** 数据是否缺失、状态是否正确、关联是否完整
3. **调用链层面：** 上游服务是否正常、参数传递是否正确
4. **环境层面：** 配置是否正确、资源是否充足

**分析方法：**

- 对比代码逻辑与实际数据
- 追踪数据流向和转换过程
- 确认异常发生的精确条件

---

### Step 6: 给出解决方案

**输出内容：**

1. **问题根因：** 清晰描述导致问题的根本原因
2. **影响分析：** 影响范围、数据影响、业务影响
3. **解决方案：**
   - 临时解决方案（快速止血）
   - 长期修复方案（根治问题）
4. **验证建议：** 如何验证修复是否有效

---

## 执行检查清单

- [ ] 已使用 jaeger-analysis 解析链路追踪
- [ ] 已使用 git-fetch 获取并查看相关源码
- [ ] 已根据需要使用 database_query 查询数据（仅限 SELECT）
- [ ] 已定位到问题根因
- [ ] 已提供明确的解决方案

---

## 注意事项

1. **Jaeger 数据必查：** 只要存在 jaeger 数据，必须先解析，不可跳过
2. **源码必看：** 获取到堆栈后，必须查看对应源码，不可仅凭猜测
3. **数据库只读：** 数据库操作严格限制为查询，禁止任何写入操作
4. **逐步推进：** 按照流程顺序执行，每步确认完成后再进入下一步
